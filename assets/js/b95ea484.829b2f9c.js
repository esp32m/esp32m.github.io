"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3488],{3564:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var t=n(5893),i=n(1151);const r={sidebar_position:3,title:"API"},a="API",o={id:"reference/api",title:"API",description:"ESP32 Manager features built-in event dispatcher with publish/subscribe capabilities, used both for internal communications, and for interacting with the outer world. The latter constitutes the API (Application Programming Interface), that essentially is a method of exchanging messages bearing information about state changes, containing commands, requests, results of command execution, etc.",source:"@site/docs/reference/api.md",sourceDirName:"reference",slug:"/reference/api",permalink:"/docs/reference/api",draft:!1,unlisted:!1,editUrl:"https://github.com/esp32m/website/edit/master/website/docs/reference/api.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,title:"API"},sidebar:"tutorialSidebar",previous:{title:"Project structure",permalink:"/docs/reference/project-structure"},next:{title:"Components",permalink:"/docs/reference/components"}},l={},c=[{value:"WebSockets",id:"websockets",level:2},{value:"Server setup",id:"server-setup",level:3},{value:"Client setup",id:"client-setup",level:3},{value:"Message format",id:"message-format",level:3},{value:"MQTT",id:"mqtt",level:2},{value:"Setup",id:"setup",level:3},{value:"Message format",id:"message-format-1",level:3},{value:"Example",id:"example",level:3}];function d(e){const s={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{id:"api",children:"API"}),"\n",(0,t.jsxs)(s.p,{children:["ESP32 Manager features built-in event dispatcher with publish/subscribe capabilities, used both for internal communications, and for interacting with the outer world. The latter constitutes the API (Application Programming Interface), that essentially is a method of exchanging messages bearing information about state changes, containing commands, requests, results of command execution, etc.\r\nThe API implements client-server mode of interaction, where ESP32 is a ",(0,t.jsx)(s.code,{children:"server"}),", and external connections are initiated by ",(0,t.jsx)(s.code,{children:"clients"}),".\r\nThe API protocol has 2 layers:"]}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Message layer"})," - routes the messages to their destinations (modules/tasks/devices) within the application."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Transport layer"})," - encodes the messages to be transmitted over a network medium, and decodes incoming network packets."]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.strong,{children:"Message layer"})," uses unified message format, with the following fields:"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"type"})," (string, mandatory), one of:","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.em,{children:"request"})," - usually client-to-server, requests to run a command or report the state. Requests may or may not require responses, there may be multiple responses to a single request (for example, to report progress), or the responses may be partial (for example, to transmit large chunks of data);"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.em,{children:"response"})," - usually server-to-client, contains the result of command execution, current state, etc.;"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.em,{children:"broadcast"})," - usually server-to-all-clients, communicates critical notifications, such as start/finish of application update;"]}),"\n",(0,t.jsxs)(s.li,{children:["other message types are possible, but currently are not recognized and silently dropped by the ",(0,t.jsx)(s.code,{children:"esp32m"}),";"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"name"})," (string, mandatory) - defines the purpose/meaning of the message, for example:","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.em,{children:"state-get"})," - instructs the server to report the state of the specified (by ",(0,t.jsx)(s.em,{children:"target"})," field) device, task, module, etc.;"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.em,{children:"state-set"})," - instructs the server to change state of the specified target;"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.em,{children:"config-get"})," - requests configuration of the specified target;"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.em,{children:"config-set"})," - changes configuration of the specified target;"]}),"\n",(0,t.jsxs)(s.li,{children:["other names are target-specific. For example, ",(0,t.jsx)(s.em,{children:"scan"})," command for the ",(0,t.jsx)(s.em,{children:"wifi"})," target starts AP scanning process;"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"target"})," (string, mandatory for ",(0,t.jsx)(s.em,{children:"request"})," messages) - name of the module/task/device that must process the message (and respond to, if necessary);"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"source"})," (string, mandatory for ",(0,t.jsx)(s.em,{children:"response"})," and ",(0,t.jsx)(s.em,{children:"broadcast"})," messages) - name of the module/task/device that is responding to the message;"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"seq"})," (integer, optional) - message sequence, allows asynchronous processing of requests and responses;"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"data"})," (variant, optional) - provides arguments to the command, result of execution or details of notification;"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"partial"})," (boolean, optional) - if true, more messages of this type from the same sender are expected."]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["Asynchronous messaging is fully supported, i.e. an endpoint may send multiple requests before seeing any response. The ordering of messages is not important, but in order to avoid ambiguity, the usage of ",(0,t.jsx)(s.strong,{children:"seq"})," field is encouraged. Usually, the requesting endpoint picks a random 32-bit signed integer when the connection is established, and increments it with every new message. The responding endpoint must include ",(0,t.jsx)(s.strong,{children:"seq"})," field in the response message, with the value matching the request."]}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.strong,{children:"Transport layer"})," can be implemented using any protocol capable of exchanging data packets, i.e. TCP, UDP, Bluetooth, WebSockets, MQTT or any other. Currently, only ",(0,t.jsx)(s.strong,{children:"WebSockets"})," and ",(0,t.jsx)(s.strong,{children:"MQTT"})," are implemented."]}),"\n",(0,t.jsx)(s.h2,{id:"websockets",children:"WebSockets"}),"\n",(0,t.jsx)(s.h3,{id:"server-setup",children:"Server setup"}),"\n",(0,t.jsxs)(s.p,{children:["If ",(0,t.jsx)(s.code,{children:"esp32m"})," application is compiled with the embedded UI, the WebSockets transport is added to the application by default, because WebSockets protocol is used for communications between the UI frontend and the backend. It is also possible to provide WebSockets API without serving UI pages from the MCU. Add the following code to your ",(0,t.jsx)(s.code,{children:"main.cpp"})," to enable WebSockets API without embedded UI:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-cpp",children:"#include <esp32m/ui.hpp>\r\n#include <esp32m/ui/httpd.hpp>\r\n\r\n...\r\n\r\nnew Ui(new ui::Httpd())\n"})}),"\n",(0,t.jsx)(s.h3,{id:"client-setup",children:"Client setup"}),"\n",(0,t.jsxs)(s.p,{children:["Any client that understands generic WebSockets protocol and capable of sending/receiving text messages will do. For example, ",(0,t.jsx)(s.a,{href:"//github.com/aar0u/WebSocket-Test-Client",children:"WebSocket Test Client"}),", available as a Google Chrome extension."]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"esp32m"})," WebSockets server listens on the ",(0,t.jsx)(s.code,{children:"/ws"})," endpoint, you need to use ",(0,t.jsx)(s.code,{children:"ws://ip-or-name-of-esp32/ws"})," URL to connect via WebSockets client.\r\nOnce connected, you can send requests and see the responses in your WebSockets client"]}),"\n",(0,t.jsx)(s.h3,{id:"message-format",children:"Message format"}),"\n",(0,t.jsx)(s.p,{children:"WebSockets transport uses JSON encoding for the messages. A single text frame may contain one or multiple message. If one message is transmitted, the frame contains JSON-encoded message, an object with the fields matching message fields (see above). If multiple messages are transmitted, the frame contains JSON array of objects, where each object is a JSON-encoded message."}),"\n",(0,t.jsx)(s.p,{children:"Example of a single-message frame:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-json",children:'{"type":"request","target":"app","name":"state-get","seq":869657919}\n'})}),"\n",(0,t.jsx)(s.p,{children:"Example of a multi-message frame:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-json",children:'[\r\n    {"type":"request","target":"ota","name":"config-get","seq":869657920},\r\n    {"type":"request","target":"ESP32","name":"config-get","seq":869657921},\r\n    {"type":"request","target":"ota","name":"state-get","seq":869657922}\r\n]\n'})}),"\n",(0,t.jsx)(s.h2,{id:"mqtt",children:"MQTT"}),"\n",(0,t.jsxs)(s.p,{children:["MQTT protocol within ",(0,t.jsx)(s.code,{children:"esp32m"})," is mostly used to publish sensor readings to a time-series database, but it has also been adopted to process ",(0,t.jsx)(s.code,{children:"esp32m"})," messages. However, as it is a connectionless and stateless protocol, there are certain limitations:"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"it is not possible to address devices with the same name connected to a single MQTT server, each device must have unique name;"}),"\n",(0,t.jsx)(s.li,{children:"if the message does not send a mandatory response, there's no way to tell if the message was delivered;"}),"\n",(0,t.jsx)(s.li,{children:"MQTT messages may be observed by other (unrelated or undesirable) MQTT clients, which may have security implications."}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"setup",children:"Setup"}),"\n",(0,t.jsxs)(s.p,{children:["Refer to ",(0,t.jsx)(s.a,{href:"/docs/tutorial/mqtt",children:"MQTT setup"})," tutorial page for details."]}),"\n",(0,t.jsx)(s.h3,{id:"message-format-1",children:"Message format"}),"\n",(0,t.jsx)(s.p,{children:"MQTT message consists of two parts:"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["Message topic. The topic is a path-like string, that contains the following segments, separated by a forward slash ('/'):","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"esp32m - this is a mandatory prefix that identifies esp32m message;"}),"\n",(0,t.jsx)(s.li,{children:"message type;"}),"\n",(0,t.jsx)(s.li,{children:"project name;"}),"\n",(0,t.jsx)(s.li,{children:"module/task/device name;"}),"\n",(0,t.jsx)(s.li,{children:"sequence (optional)."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["Message data. This is a JSON-encoded ",(0,t.jsx)(s.strong,{children:"data"})," field of the message. If your message doesn't contain data, just pass empty string."]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"example",children:"Example"}),"\n",(0,t.jsxs)(s.p,{children:["This example uses ",(0,t.jsx)(s.a,{href:"//mosquitto.org/",children:"Mosquitto"})," command-line clients (",(0,t.jsx)(s.code,{children:"mosquitto_sub"})," and ",(0,t.jsx)(s.code,{children:"mosquitto_pub"}),") and assumes that ",(0,t.jsx)(s.code,{children:"esp32m"})," project with the name ",(0,t.jsx)(s.code,{children:"basic"})," is running on your ESP32 module and is connected to a ",(0,t.jsx)(s.a,{href:"//mosquitto.org/",children:"Mosquitto server"}),"."]}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsx)(s.li,{children:"Open two shell terminal windows on the machine where Mosquitto server is installed."}),"\n",(0,t.jsxs)(s.li,{children:["Run this command in the first terminal:","\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"$ mosquitto_sub -t 'esp32m/response/#' -v\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["Run this command in the second terminal:","\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"$ mosquitto_pub -t 'esp32m/request/basic/app/state-get' -m ''\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["Watch the first terminal, you should see:","\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-json",children:'esp32m/response/basic/app {"name":"basic","time":1624889782,"uptime":109310948,"version":"0.0.13","built":"Jun 25 2021 10:01:46","sdk":"v4.4-dev-1594-g1d7068e4be-dirty","size":1475264}\n'})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,i.a)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},1151:(e,s,n)=>{n.d(s,{Z:()=>o,a:()=>a});var t=n(7294);const i={},r=t.createContext(i);function a(e){const s=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(r.Provider,{value:s},e.children)}}}]);