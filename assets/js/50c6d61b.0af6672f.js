"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2221],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>h});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function p(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),l=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=l(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),d=l(a),h=i,m=d["".concat(s,".").concat(h)]||d[h]||u[h]||r;return a?n.createElement(m,o(o({ref:t},c),{},{components:a})):n.createElement(m,o({ref:t},c))}));function h(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=d;var p={};for(var s in t)hasOwnProperty.call(t,s)&&(p[s]=t[s]);p.originalType=e,p.mdxType="string"==typeof e?e:i,o[1]=p;for(var l=2;l<r;l++)o[l]=a[l];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},8236:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>p,toc:()=>l});var n=a(7462),i=(a(7294),a(3905));const r={sidebar_position:3},o="OTA updates",p={unversionedId:"tutorial/ota",id:"tutorial/ota",title:"OTA updates",description:"OTA (Over-The-Air) feature allows to flash new application using WiFi connection, by downloading the application binary from a remote HTTP server.",source:"@site/docs/tutorial/ota.md",sourceDirName:"tutorial",slug:"/tutorial/ota",permalink:"/docs/tutorial/ota",draft:!1,editUrl:"https://github.com/esp32m/website/edit/master/website/docs/tutorial/ota.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"MQTT setup",permalink:"/docs/tutorial/mqtt"},next:{title:"Remote Logging",permalink:"/docs/tutorial/remote-logging"}},s={},l=[{value:"Setting up HTTP server",id:"setting-up-http-server",level:2},{value:"Uploading the application",id:"uploading-the-application",level:2},{value:"Setting up the client",id:"setting-up-the-client",level:2},{value:"Partition table considerations",id:"partition-table-considerations",level:2},{value:"Updating the application",id:"updating-the-application",level:2},{value:"From the User Interface",id:"from-the-user-interface",level:3},{value:"Using the WebSockets API",id:"using-the-websockets-api",level:3},{value:"Using the MQTT API",id:"using-the-mqtt-api",level:3}],c={toc:l};function u(e){let{components:t,...r}=e;return(0,i.kt)("wrapper",(0,n.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"ota-updates"},"OTA updates"),(0,i.kt)("p",null,"OTA (Over-The-Air) feature allows to flash new application using WiFi connection, by downloading the application binary from a remote HTTP server."),(0,i.kt)("h2",{id:"setting-up-http-server"},"Setting up HTTP server"),(0,i.kt)("p",null,"Use any HTTP server of your choice (for example, ",(0,i.kt)("a",{parentName:"p",href:"//www.nginx.com/"},"Nginx"),"). The server must allow binary file downloads, and must be accessible to your ESP32 device either by IP or by DNS name. It is advisable to set up TLS encryption (",(0,i.kt)("inlineCode",{parentName:"p"},"https://")," protocol), especially if you plan to update application over the Internet, to enforce integrity of your application. One of the easiest way to set up free TLS certificate is by using a ",(0,i.kt)("a",{parentName:"p",href:"//certbot.eff.org/"},"Certbot"),"."),(0,i.kt)("h2",{id:"uploading-the-application"},"Uploading the application"),(0,i.kt)("p",null,"You can either do that manually by copying the ",(0,i.kt)("inlineCode",{parentName:"p"},"dist/firmware.bin")," to the download directory of your HTTP server, or configure our ",(0,i.kt)("a",{parentName:"p",href:"/docs/reference/esp32m-py"},"esp32m.py tool")," to automatically copy the application binary after the build process is complete. You just need to specify the path to the download directory in the ",(0,i.kt)("inlineCode",{parentName:"p"},"esp32m.json")," config file, or using the command line. ",(0,i.kt)("a",{parentName:"p",href:"/docs/reference/esp32m-py"},"This page")," provides details on how to do that. Note that the binary application file in the ",(0,i.kt)("inlineCode",{parentName:"p"},"dist/")," folder is named after your project name."),(0,i.kt)("h2",{id:"setting-up-the-client"},"Setting up the client"),(0,i.kt)("p",null,"OTA module must be included and initialized in your project, like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-cpp"},"#include <esp32m/net/ota.hpp>\n")),(0,i.kt)("p",null,"at the start of your ",(0,i.kt)("inlineCode",{parentName:"p"},"main.cpp"),", and "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-cpp"},"net::useOta();\n")),(0,i.kt)("p",null,"in the ",(0,i.kt)("inlineCode",{parentName:"p"},"void app_main()")),(0,i.kt)("h2",{id:"partition-table-considerations"},"Partition table considerations"),(0,i.kt)("p",null,"OTA update process is a native ESP-IDF feature explained in detail in ",(0,i.kt)("a",{parentName:"p",href:"//docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/ota.html"},"this article"),". In short, ESP-IDF maintains at least two separate slots of the same size in the partition table (ota_0 and ota_1), of which one is currently running application, and the other one is used to download new application. If the download process was successful and all integrity checks were OK, the second partition becomes active, and the first one will accept the\napplication binary on the next update, and so on. This approach allows to survive incomplete or broken updates, but requires twice as much flash memory. Therefore, only a little less than 2MB of flash remains available for the application. If you want to use OTA with a bigger application, or need flash space for other purposes, consider ESP32 module with 8MB or 16MB flash chip."),(0,i.kt)("h2",{id:"updating-the-application"},"Updating the application"),(0,i.kt)("h3",{id:"from-the-user-interface"},"From the User Interface"),(0,i.kt)("p",null,"Click on the ",(0,i.kt)("inlineCode",{parentName:"p"},"System")," link in the sidebar menu and enter the application URL in the ",(0,i.kt)("inlineCode",{parentName:"p"},"Administration")," box, then click Update:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"administration",src:a(6036).Z,width:"574",height:"272"})),(0,i.kt)("p",null,"If the progress bar appears in a few seconds - the update process has started, and must not be interrupted until finished. You will not be able to use the device during the update process. When the update is finished, the MCU will reboot automatically and should become accessible again within a few seconds. If the progress bar doesn't appear for a long time (over 20 seconds), it usually means that the MCU cannot download the application binary for some reason. Check the URL, make sure that you can download application from a browser and check if your firewall blocks the MCU. You can also set up ",(0,i.kt)("a",{parentName:"p",href:"/docs/tutorial/remote-logging"},"Remote logging")," to check for extended error/warning messages."),(0,i.kt)("h3",{id:"using-the-websockets-api"},"Using the WebSockets API"),(0,i.kt)("p",null,"Establish WebSockets connection with your ESP32 and send this message to start application update:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{"type":"request","target":"ota","name":"update","data":{"url":"https://my-server.net/firmware/my-firmware.bin"}}\n')),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"/docs/reference/api#websockets"},"See details")," on WebSockets API"),(0,i.kt)("h3",{id:"using-the-mqtt-api"},"Using the MQTT API"),(0,i.kt)("p",null,"Send the message "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{"url":"https://my-server.net/firmware/my-firmware.bin"}\n')),(0,i.kt)("p",null,"to the target ",(0,i.kt)("inlineCode",{parentName:"p"},"esp32m/request/project_name/ota/update")," (replace ",(0,i.kt)("inlineCode",{parentName:"p"},"project_name")," with the name of your project)"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"/docs/reference/api#mqtt"},"See details")," on MQTT API"))}u.isMDXComponent=!0},6036:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/administration-71cf5ba4cd58098f0f6383bbe76f24b1.png"}}]);